{% extends 'admin/base.html.twig' %}

{% block title %}Détail du signalement #{{ signale.id }} - Administration{% endblock %}

{% block admin_content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Détail du signalement #{{ signale.id }}</h1>
    <div>
        <a href="{{ path('admin_signalements') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Retour à la liste
        </a>
    </div>
</div>

<div class="row">
    <!-- Informations du signalement -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Informations du signalement</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Date du signalement :</strong><br>
                        {{ signale.dateSignalement|date('d/m/Y à H:i') }}
                    </div>
                    <div class="col-md-6">
                        <strong>Statut :</strong><br>
                        <span class="badge bg-{{ signale.statutCssClass }} fs-6">
                            {{ signale.statutFormate }}
                        </span>
                    </div>
                </div>
                
                <hr>
                
                <div class="row">
                    <div class="col-md-6">
                        <strong>Nature du signalement :</strong><br>
                        {% if signale.signalement %}
                            <span class="badge bg-secondary fs-6">{{ signale.signalement.natureSignalement }}</span>
                        {% else %}
                            <em class="text-muted">Non spécifiée</em>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <strong>Signalé par :</strong><br>
                        {% if signale.signalePar %}
                            {{ signale.signalePar.prenom }} {{ signale.signalePar.nom }}<br>
                            <small class="text-muted">{{ signale.signalePar.email }}</small>
                        {% else %}
                            <em class="text-muted">Utilisateur supprimé</em>
                        {% endif %}
                    </div>
                </div>
                
                {% if signale.commentaire %}
                <hr>
                <div>
                    <strong>Commentaire du signalement :</strong><br>
                    <div class="bg-light p-3 rounded mt-2">
                        {{ signale.commentaire|nl2br }}
                    </div>
                </div>
                {% endif %}
                
                {% if signale.dateTraitement %}
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Date de traitement :</strong><br>
                        {{ signale.dateTraitement|date('d/m/Y à H:i') }}
                    </div>
                    <div class="col-md-6">
                        <strong>Traité par :</strong><br>
                        {% if signale.traitePar %}
                            {{ signale.traitePar.prenom }} {{ signale.traitePar.nom }}
                        {% else %}
                            <em class="text-muted">Administrateur supprimé</em>
                        {% endif %}
                    </div>
                </div>
                
                {% if signale.reponseAdmin %}
                <div class="mt-3">
                    <strong>Réponse de l'administrateur :</strong><br>
                    <div class="bg-light p-3 rounded mt-2">
                        {{ signale.reponseAdmin|nl2br }}
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Informations du produit signalé -->
        {% if signale.produit %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Produit signalé</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>{{ signale.produit.nom }}</h6>
                        <p class="text-muted">{{ signale.produit.description|slice(0, 200) }}{% if signale.produit.description|length > 200 %}...{% endif %}</p>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Prix :</strong> {{ signale.produit.prixInitial }} €
                            </div>
                            <div class="col-md-6">
                                <strong>Vendeur :</strong>
                                {% if signale.produit.proprietaire %}
                                    {{ signale.produit.proprietaire.prenom }} {{ signale.produit.proprietaire.nom }}
                                {% else %}
                                    <em class="text-muted">Utilisateur supprimé</em>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <a href="{{ path('app_annonce_details', {id: signale.produit.id}) }}" 
                           class="btn btn-outline-info mb-2" target="_blank">
                            <i class="fas fa-external-link-alt me-1"></i>Voir l'annonce
                        </a>
                        <br>
                        {% if signale.isEnAttente %}
                        <button type="button" class="btn btn-danger btn-sm" 
                                data-bs-toggle="modal" data-bs-target="#modal-supprimer-produit">
                            <i class="fas fa-trash me-1"></i>Supprimer le produit
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card mb-4">
            <div class="card-body text-center">
                <i class="fas fa-exclamation-triangle text-warning fa-3x mb-3"></i>
                <h5>Produit supprimé</h5>
                <p class="text-muted">Le produit signalé a été supprimé.</p>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Actions -->
    <div class="col-lg-4">
        {% if signale.isEnAttente %}
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Actions</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ path('admin_signalement_traiter', {id: signale.id}) }}">
                    <div class="mb-3">
                        <label for="reponse" class="form-label">Réponse de l'administrateur</label>
                        <textarea name="reponse" id="reponse" class="form-control" rows="4" 
                                  placeholder="Commentaire optionnel sur le traitement..."></textarea>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" name="action" value="traiter" 
                                class="btn btn-success"
                                onclick="return confirm('Marquer ce signalement comme traité ?')">
                            <i class="fas fa-check me-1"></i>Marquer comme traité
                        </button>
                        
                        <button type="submit" name="action" value="rejeter" 
                                class="btn btn-warning"
                                onclick="return confirm('Rejeter ce signalement ?')">
                            <i class="fas fa-times me-1"></i>Rejeter le signalement
                        </button>
                    </div>
                </form>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center">
                <i class="fas fa-check-circle text-{{ signale.isTraite ? 'success' : 'warning' }} fa-3x mb-3"></i>
                <h5>Signalement {{ signale.statutFormate|lower }}</h5>
                <p class="text-muted">
                    Ce signalement a été {{ signale.statutFormate|lower }} 
                    le {{ signale.dateTraitement|date('d/m/Y à H:i') }}.
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de suppression du produit -->
{% if signale.isEnAttente and signale.produit %}
<div class="modal fade" id="modal-supprimer-produit" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Supprimer le produit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ path('admin_signalement_supprimer_produit', {id: signale.id}) }}">
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Attention !</strong> Cette action va supprimer définitivement le produit 
                        "{{ signale.produit.nom }}" et marquer le signalement comme traité.
                    </div>
                    
                    <div class="mb-3">
                        <label for="reponse-suppression" class="form-label">Raison de la suppression</label>
                        <textarea name="reponse" id="reponse-suppression" class="form-control" rows="3" 
                                  placeholder="Expliquez pourquoi le produit est supprimé...">Produit supprimé suite au signalement pour violation des conditions d'utilisation.</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i>Supprimer le produit
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
